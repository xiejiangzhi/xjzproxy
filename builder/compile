#! /usr/bin/env ruby

require 'zlib'

app_dir = File.expand_path('../../', __FILE__)
rbdata = {}
public_key = File.read(File.join(app_dir, 'licenses/license_key.pub'))
LICENSE_PREFIX = '__LICENSE_CHECK_'

def license_checker(flags)
  require 'pry'
  binding.pry
  false
end

def compile(path)
  code = File.read(path)
  lines = code.lines.each_with_object([]) do |line, r|
    next if line =~ /^\s*(#.*)?$/
    line.gsub!(/^\s+/, '')
    if line.start_with?(LICENSE_PREFIX)
      line.gsub!(/#{LICENSE_PREFIX}(\w+)__/) do |s|
        flags = s[(LICENSE_PREFIX.length)..-3].split('_')
        license_checker(flags)
      end
    else
      r << line
    end
  end
  code = lines.join

  require 'pry'
  binding.pry if  path =~ /config.rb/

  RubyVM::InstructionSequence.compile(
    code, path, path
  ).to_binary
end

Dir.chdir(app_dir) do
  Dir[*%w{*.rb src/xjz/**/*.rb}].each do |path|
    next if path == 'src/xjz/loader.rb'
    rbdata[path] = compile(path)
  end
  puts "Compiled Ruby Code"

  Dir[*%w{src/static/**/* src/webviews/**/*}].each do |path|
    next if File.directory?(path)
    rbdata[path] = File.read(path)
  end
  puts "Saved JS and Templates"
end

data = rbdata.map do |k, v|
  is_utf8 = v.encoding == Encoding::UTF_8 ? 1 : 0
  [
    [1, k.bytesize].pack("CN"), k,
    [is_utf8, v.bytesize].pack("CN"), v.force_encoding('binary')
  ].join
end.join

out_path = File.join(app_dir, 'data')
n = 9 + rand(128)
data = [
  [n].pack('C'),
  Random.bytes(n),
  Zlib::Deflate.deflate(data),
  Random.bytes(n)
].join
File.write(out_path, data)

puts "Output #{out_path}"

puts 'Done'
